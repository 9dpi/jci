<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mô hình chuẩn JCI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f172a;
            --text: #f1f5f9;
            --card: #1e293b;
            --primary: #3b82f6;
            --accent: #facc15;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        header {
            height: 70px;
            background-color: var(--card);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
        }

        .header-left {
            flex: 1;
        }

        .header-center {
            flex: 2;
            display: flex;
            justify-content: center;
        }

        .header-right {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .main-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: calc(100vh - 70px);
        }

        .floor-nav {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 8px;
        }

        .floor-btn {
            padding: 6px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }

        .floor-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        #info-panel {
            background: var(--card);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .jci-item {
            margin-bottom: 10px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .jci-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }

        .jci-header:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .jci-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
            font-size: 13px;
            line-height: 1.6;
        }

        .jci-content div {
            padding: 15px;
            color: #cbd5e1;
        }

        .jci-item.active .jci-content {
            max-height: 1000px;
        }

        .jci-item.active .fa-chevron-down {
            transform: rotate(180deg);
        }

        #hospital-frame {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #0b1120;
            padding: 10px;
            overflow: hidden;
        }

        #hospital-map {
            max-width: 100%;
            max-height: calc(100vh - 120px);
            object-fit: contain;
        }

        .hotspot {
            position: absolute;
            width: 22px;
            height: 22px;
            background-color: #ef4444;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            z-index: 10;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .hotspot::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #ef4444;
            border-radius: 50%;
            animation: pulse 2s infinite;
            top: 0;
            left: 0;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .hotspot-label {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            font-weight: 600;
            pointer-events: none;
        }

        .guide-box {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.9);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="dark">
    <header>
        <div class="header-left">
            <h1 class="text-xl font-bold uppercase leading-none" style="color: var(--accent);">Mô hình chuẩn JCI</h1>
            <p class="text-[10px] opacity-60">Mô hình JCI trong quản lý bệnh viện</p>
        </div>

        <div class="header-center">
            <nav class="floor-nav">
                <div class="floor-btn" onclick="changeFloor('basement')" id="btn-basement">Tầng hầm</div>
                <div class="floor-btn active" onclick="changeFloor('floor1')" id="btn-floor1">Tầng 1</div>
                <div class="floor-btn" onclick="changeFloor('floor2')" id="btn-floor2">Tầng 2</div>
            </nav>
        </div>

        <div class="header-right">
            <div class="text-right border-l border-gray-700 pl-4">
                <p class="text-sm font-bold text-slate-200">Vũ Quang Cường</p>
                <p class="text-[11px] text-blue-400 font-medium">0912580018</p>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside id="info-panel">
            <div id="welcome-msg">
                <h2 class="text-lg font-bold mb-2" style="color: var(--accent);">Thông tin JCI</h2>
                <p class="text-sm opacity-60 italic">Bấm vào các điểm trên sơ đồ để xem tiêu chuẩn.</p>
            </div>
            <div id="panel-data" class="hidden">
                <h2 id="room-title"
                    class="text-xl font-bold text-blue-400 border-b border-gray-700 pb-2 mb-4 uppercase"></h2>
                <div id="jci-accordion" class="space-y-2"></div>
            </div>
        </aside>

        <main id="hospital-frame">
            <div id="layout-wrapper">
                <img src="./images/layout_Tang1.png" id="hospital-map" alt="Hospital Layout">
                <div id="hotspot-container"></div>
            </div>
            <div class="guide-box"><i class="fas fa-hand-pointer mr-2 animate-bounce text-blue-400"></i> Click vào các
                điểm nhấp nháy</div>
        </main>
    </div>

    <script>
        // Cấu hình URL Google Sheets
        const SHEET_URLS = {
            'basement': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGBPqMRgIYC7m3905vg5MIWNDvrrNd_Jeg6rGhJ8NW8TcEgKtBTeDBZp-FMV2t36e-qqphNcfDZe-0/pub?gid=0&output=csv',
            'floor1': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGBPqMRgIYC7m3905vg5MIWNDvrrNd_Jeg6rGhJ8NW8TcEgKtBTeDBZp-FMV2t36e-qqphNcfDZe-0/pub?gid=1860361468&output=csv',
            'floor2': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGBPqMRgIYC7m3905vg5MIWNDvrrNd_Jeg6rGhJ8NW8TcEgKtBTeDBZp-FMV2t36e-qqphNcfDZe-0/pub?gid=1191021628&output=csv'
        };

        let fullJciDatabase = {};
        let dynamicHotspots = { 'basement': [], 'floor1': [], 'floor2': [] };

        async function loadAllData() {
            for (const [key, url] of Object.entries(SHEET_URLS)) {
                try {
                    const response = await fetch(url);
                    const csvText = await response.text();
                    const rows = csvText.split('\n').slice(1);

                    rows.forEach(row => {
                        const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        if (cols.length >= 4) {
                            const roomID = cols[0].trim();
                            if (!fullJciDatabase[roomID]) fullJciDatabase[roomID] = { title: roomID.toUpperCase(), standards: [] };
                            fullJciDatabase[roomID].standards.push({
                                code: cols[1].trim(),
                                name: cols[2].trim(),
                                content: cols[3].trim().replace(/^"|"$/g, '')
                            });

                            if (cols[4] && cols[5]) {
                                if (!dynamicHotspots[key].find(h => h.id === roomID)) {
                                    dynamicHotspots[key].push({
                                        id: roomID, label: roomID,
                                        top: cols[5].trim() + '%', left: cols[4].trim() + '%'
                                    });
                                }
                            }
                        }
                    });
                } catch (e) { console.error(`Lỗi nạp tầng ${key}:`, e); }
            }
        }

        function changeFloor(floorKey) {
            document.querySelectorAll('.floor-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${floorKey}`).classList.add('active');
            const mapImg = document.getElementById('hospital-map');
            const imgName = floorKey === 'basement' ? 'TangHam' : (floorKey === 'floor1' ? 'Tang1' : 'Tang2');
            mapImg.src = `./images/layout_${imgName}.png`;
            renderHotspots(dynamicHotspots[floorKey]);
            document.getElementById('welcome-msg').classList.remove('hidden');
            document.getElementById('panel-data').classList.add('hidden');
        }

        function renderHotspots(hotspots) {
            const container = document.getElementById('hotspot-container');
            container.innerHTML = '';
            hotspots.forEach(spot => {
                const div = document.createElement('div');
                div.className = 'hotspot';
                div.style.top = spot.top; div.style.left = spot.left;
                div.onclick = (e) => { e.stopPropagation(); showInfo(spot.id); };
                div.innerHTML = `<div class="hotspot-label">${spot.label}</div>`;
                container.appendChild(div);
            });
        }

        function showInfo(id) {
            const data = fullJciDatabase[id];
            if (!data) return;
            document.getElementById('welcome-msg').classList.add('hidden');
            document.getElementById('panel-data').classList.remove('hidden');
            document.getElementById('room-title').innerText = data.title;
            const accordion = document.getElementById('jci-accordion');
            accordion.innerHTML = data.standards.map((s, i) => `
                <div class="jci-item" id="item-${i}">
                    <div class="jci-header" onclick="toggleAccordion('item-${i}')">
                        <span>${s.code}: ${s.name}</span>
                        <i class="fas fa-chevron-down text-xs transition-transform"></i>
                    </div>
                    <div class="jci-content"><div>${s.content}</div></div>
                </div>
            `).join('');
        }

        function toggleAccordion(id) {
            const item = document.getElementById(id);
            const isActive = item.classList.contains('active');
            document.querySelectorAll('.jci-item').forEach(el => el.classList.remove('active'));
            if (!isActive) item.classList.add('active');
        }

        // CHẾ ĐỘ ADMIN ẨN ĐỂ LẤY TỌA ĐỘ
        // Chỉ hoạt động khi bạn thêm "?admin=1" vào cuối URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === '1') {
            document.getElementById('hospital-map').style.cursor = 'crosshair';
            document.getElementById('hospital-map').addEventListener('click', function (e) {
                const rect = e.target.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(1);
                const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(1);
                prompt("Dán vào Cột E (X) và F (Y) trong Sheet:", `${x}, ${y}`);
            });
        }

        window.onload = async () => {
            await loadAllData();
            renderHotspots(dynamicHotspots.floor1);
        };
    </script>
</body>

</html>